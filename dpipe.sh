#!/bin/bash
# usage
# Check current kernel ./dpipe.sh
# Check specific kernel ./dpipe.sh 5.10.102

VULNERABLE_VERSIONS_KERNEL=(
    '4.18.0-80.1.2.el8_0'
    '4.18.0-80.4.2.el8_0'
    '4.18.0-80.7.1.el8_0'
    '4.18.0-80.7.2.el8_0'
    '4.18.0-80.11.1.el8_0'
    '4.18.0-80.11.2.el8_0'
    '4.18.0-80.15.1.el8_0'
    '4.18.0-80.16.1.el8_0'
    '4.18.0-80.18.1.el8_0'
    '4.18.0-80.23.2.el8_0'
    '4.18.0-80.27.1.el8_0'
    '4.18.0-80.27.2.el8_0'
    '4.18.0-80.29.1.el8_0'
    '4.18.0-80.30.1.el8_0'
    '4.18.0-80.31.1.el8_0'
    '4.18.0-80.el8'
    '4.18.0-147.0.2.el8_1'
    '4.18.0-147.0.3.el8_1'
    '4.18.0-147.3.1.el8_1'
    '4.18.0-147.5.1.el8_1'
    '4.18.0-147.8.1.el8_1'
    '4.18.0-147.13.2.el8_1'
    '4.18.0-147.20.1.el8_1'
    '4.18.0-147.24.2.el8_1'
    '4.18.0-147.27.1.el8_1'
    '4.18.0-147.32.1.el8_1'
    '4.18.0-147.34.1.el8_1'
    '4.18.0-147.38.1.el8_1'
    '4.18.0-147.43.1.el8_1'
    '4.18.0-147.44.1.el8_1'
    '4.18.0-147.48.1.el8_1'
    '4.18.0-147.51.1.el8_1'
    '4.18.0-147.51.2.el8_1'
    '4.18.0-147.52.1.el8_1'
    '4.18.0-147.54.2.el8_1'
    '4.18.0-147.56.1.el8_1'
    '4.18.0-147.57.1.el8_1'
    '4.18.0-147.58.1.el8_1'
    '4.18.0-147.59.1.el8_1'
    '4.18.0-147.el8'
    '4.18.0-193.1.2.el8_2'
    '4.18.0-193.6.3.el8_2'
    '4.18.0-193.12.1.el8_2'
    '4.18.0-193.13.2.el8_2'
    '4.18.0-193.14.3.el8_2'
    '4.18.0-193.19.1.el8_2'
    '4.18.0-193.23.1.el8_2'
    '4.18.0-193.24.1.el8_2.dt1'
    '4.18.0-193.28.1.el8_2'
    '4.18.0-193.29.1.el8_2'
    '4.18.0-193.37.1.el8_2'
    '4.18.0-193.40.1.el8_2'
    '4.18.0-193.41.1.el8_2'
    '4.18.0-193.46.1.el8_2'
    '4.18.0-193.47.1.el8_2'
    '4.18.0-193.51.1.el8_2'
    '4.18.0-193.56.1.el8_2'
    '4.18.0-193.60.2.el8_2'
    '4.18.0-193.64.1.el8_2'
    '4.18.0-193.65.2.el8_2'
    '4.18.0-193.68.1.el8_2'
    '4.18.0-193.70.1.el8_2'
    '4.18.0-193.71.1.el8_2'
    '4.18.0-193.75.1.el8_2'
    '4.18.0-193.el8'
    '4.18.0-221.el8'
    '4.18.0-232.el8'
    '4.18.0-234.el8'
    '4.18.0-235.el8'
    '4.18.0-240.1.1.el8_3'
    '4.18.0-240.8.1.el8_3'
    '4.18.0-240.10.1.el8_3'
    '4.18.0-240.15.1.el8_3'
    '4.18.0-240.22.1.el8_3'
    '4.18.0-240.23.2.el8_3'
    '4.18.0-240.el8'
    '4.18.0-293.el8'
    '4.18.0-304.el8'
    '4.18.0-305.3.1.el8_4'
    '4.18.0-305.7.1.el8_4'
    '4.18.0-305.10.2.el8_4'
    '4.18.0-305.12.1.el8_4'
    '4.18.0-305.17.1.el8_4'
    '4.18.0-305.19.1.el8_4'
    '4.18.0-305.25.1.el8_4'
    '4.18.0-305.28.1.el8_4'
    '4.18.0-305.30.1.el8_4'
    '4.18.0-305.34.2.el8_4'
    '4.18.0-305.el8'
    '4.18.0-339.el8'
    '4.18.0-348.2.1.el8_5'
    '4.18.0-348.7.1.el8_5'
    '4.18.0-348.12.2.el8_5'
    '4.18.0-348.el8'

    '4.18.0-80.1.2.rt9.145.el8_0'
    '4.18.0-80.4.2.rt9.152.el8_0'
    '4.18.0-80.7.1.rt9.153.el8_0'
    '4.18.0-80.7.2.rt9.154.el8_0'
    '4.18.0-80.11.1.rt9.156.el8_0'
    '4.18.0-80.11.2.rt9.157.el8_0'
    '4.18.0-80.rt9.138.el8'
    '4.18.0-147.0.2.rt24.94.el8_1'
    '4.18.0-147.0.3.rt24.95.el8_1'
    '4.18.0-147.3.1.rt24.96.el8_1'
    '4.18.0-147.5.1.rt24.98.el8_1'
    '4.18.0-147.8.1.rt24.101.el8_1'
    '4.18.0-147.rt24.93.el8'
    '4.18.0-193.1.2.rt13.53.el8_2'
    '4.18.0-193.6.3.rt13.59.el8_2'
    '4.18.0-193.12.1.rt13.63.el8_2'
    '4.18.0-193.13.2.rt13.65.el8_2'
    '4.18.0-193.14.3.rt13.67.el8_2'
    '4.18.0-193.19.1.rt13.70.el8_2'
    '4.18.0-193.24.1.rt13.74.el8_2.dt1'
    '4.18.0-193.28.1.rt13.77.el8_2'
    '4.18.0-193.29.1.rt13.78.el8_2'
    '4.18.0-193.37.1.rt13.87.el8_2'
    '4.18.0-193.40.1.rt13.90.el8_2'
    '4.18.0-193.41.1.rt13.91.el8_2'
    '4.18.0-193.46.1.rt13.96.el8_2'
    '4.18.0-193.47.1.rt13.97.el8_2'
    '4.18.0-193.51.1.rt13.101.el8_2'
    '4.18.0-193.56.1.rt13.106.el8_2'
    '4.18.0-193.60.2.rt13.112.el8_2'
    '4.18.0-193.64.1.rt13.115.el8_2'
    '4.18.0-193.65.2.rt13.117.el8_2'
    '4.18.0-193.68.1.rt13.118.el8_2'
    '4.18.0-193.70.1.rt13.120.el8_2'
    '4.18.0-193.71.1.rt13.121.el8_2'
    '4.18.0-193.75.1.rt13.125.el8_2'
    '4.18.0-193.rt13.51.el8'
    '4.18.0-221.rt7.33.el8'
    '4.18.0-232.rt7.44.el8'
    '4.18.0-234.rt7.46.el8'
    '4.18.0-235.rt7.48.el8'
    '4.18.0-240.1.1.rt7.55.el8_3'
    '4.18.0-240.8.1.rt7.62.el8_3'
    '4.18.0-240.10.1.rt7.64.el8_3'
    '4.18.0-240.15.1.rt7.69.el8_3'
    '4.18.0-240.22.1.rt7.77.el8_3'
    '4.18.0-240.23.2.rt7.79.el8_3'
    '4.18.0-240.rt7.54.el8'
    '4.18.0-293.rt7.59.el8'
    '4.18.0-304.rt7.71.el8'
    '4.18.0-305.3.1.rt7.75.el8_4'
    '4.18.0-305.7.1.rt7.79.el8_4'
    '4.18.0-305.10.2.rt7.83.el8_4'
    '4.18.0-305.12.1.rt7.84.el8_4'
    '4.18.0-305.17.1.rt7.89.el8_4'
    '4.18.0-305.19.1.rt7.91.el8_4'
    '4.18.0-305.25.1.rt7.97.el8_4'
    '4.18.0-305.28.1.rt7.100.el8_4'
    '4.18.0-305.30.1.rt7.102.el8_4'
    '4.18.0-305.34.2.rt7.107.el8_4'
    '4.18.0-305.rt7.72.el8'
    '4.18.0-339.rt7.120.el8'
    '4.18.0-348.2.1.rt7.132.el8_5'
    '4.18.0-348.7.1.rt7.137.el8_5'
    '4.18.0-348.12.2.rt7.143.el8_5'
    '4.18.0-348.rt7.130.el8'
)

kernel=$1
ver0=$(uname -r)
ver1=$(echo ${kernel:-$(uname -r | cut -d '-' -f1)} | cut -d '.' -f1)
ver2=$(echo ${kernel:-$(uname -r | cut -d '-' -f1)} | cut -d '.' -f2)
ver3=$(echo ${kernel:-$(uname -r | cut -d '-' -f1)} | cut -d '.' -f3)

check_kernel() {
    # Checks kernel if it is in list of vulnerable kernels.
    #
    # Args:
    #     running_kernel - kernel string as returned by 'uname -r'
    #     vulnerable_versions - an array of vulnerable versions
    #
    # Prints:
    #     Vulnerable kernel string as returned by 'uname -r', or nothing

    local running_kernel="$1"
    shift
    local vulnerable_versions=( "$@" )

    for tested_kernel in "${vulnerable_versions[@]}"; do
        if [[ "$running_kernel" == *"$tested_kernel"* ]]; then
            echo "$running_kernel"
            echo Vulnerable
            exit 1
            break
        fi
    done
}

check_kernel "$ver0" "${VULNERABLE_VERSIONS_KERNEL[@]}"

if (( ${ver1:-0} < 5 )) ||
   (( ${ver1:-0} > 5 )) ||
   (( ${ver1:-0} == 5 && ${ver2:-0} < 8 )) ||
   (( ${ver1:-0} == 5 && ${ver2:-0} == 10 && ${ver3:-0} == 102 )) ||
   (( ${ver1:-0} == 5 && ${ver2:-0} == 10 && ${ver3:-0} == 92 )) ||
   (( ${ver1:-0} == 5 && ${ver2:-0} == 15 && ${ver3:-0} == 25 )) ||
   (( ${ver1:-0} == 5 && ${ver2:-0} >= 16 && ${ver3:-0} >= 11 )) ||
   (( ${ver1:-0} == 5 && ${ver2:-0} > 16 ));
then
    echo Not vulnerable: $ver0
    exit 0
else
    echo Vulnerable: $ver0
    exit 1
fi